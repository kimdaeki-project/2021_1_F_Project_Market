<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mm.market.social.SocialMapper">
	<sql id="searcher">
		<!-- 공통으로 사용하는 sql문 -->
		<where>
			<choose>
				<when test="kind=='SocialWriter'">
					socialWriter like concat('%', #{search}, '%')
				</when>

				<when test="kind=='SocialContent'">
					socialContents like concat('%', #{search}, '%')
				</when>

				<otherwise>
					socialTitle like concat('%', #{search}, '%')
				</otherwise>
			</choose>
		</where>
	</sql>

	<select id="getList" resultType="SocialVO" parameterType="Pager">
		select * from social
		<include refid="searcher"></include>
		order by socialNum desc
		limit #{startRow}, #{perPage}
	</select>

	<select id="getTotalCount" parameterType="Pager" resultType="Long">
		select count(socialNum) from social
	</select>

	<select id="getSelect" resultType="SocialVO"
		parameterType="SocialVO">
		select S.*, SF.*
		from social S left join socialFiles SF
		on S.socialNum = SF.socialNum
		where S.socialNum=#{socialNum}
	</select>

	<resultMap type="SocialVO" id="selectResult">
		<id column="socialNum" property="socialNum"></id>
		<result column="socialTitle" property="socialTitle" />
		<result column="socialCategory" property="socialCategory" />
		<result column="username" property="username" />
		<result column="socialContent" property="socialContent" />
		<result column="socialDate" property="socialDate" />
		<collection property="files" javaType="java.util.List" ofType="SocialFileVO">
			<id column="fileNum" property="fileNum" />
			<result column="fileName" property="fileName" />
			<result column="originName" property="originName" />
		</collection>
	</resultMap>

	<insert id="setInsert" parameterType="SocialVO">
		insert into social
		values(#{num}, #{title}, #{writer}, #{contents}, now(), 0)
	</insert>

	<insert id="setFileInsert" parameterType="SocialFileVO">
		insert into socialFiles (socialNum, fileName, originName)
		values (#{socialNum}, #{fileName}, #{originName})
	</insert>

	<update id="setUpdate" parameterType="SocialVO">
		update social set socialTitle=#{socialTitle}, socialContent=#{socialContent}
		where socialNum=#{socialNnum}
	</update>

	<delete id="setDelete" parameterType="SocialVO">
		delete from social where socialNum=#{socialNum}
	</delete>
</mapper>